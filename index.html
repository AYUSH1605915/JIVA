<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIVA | 3D Deep Blue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: radial-gradient(circle at center, #0a192f 0%, #020617 100%);
            overflow: hidden; height: 100vh; display: flex; align-items: center; justify-content: center;
        }

        /* Snowflake Styles */
        .snowflake { position: fixed; top: -10%; color: white; animation: fall linear infinite; opacity: 0.5; z-index: 1; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* 3D Orb Design */
        .orb-3d {
            width: 280px; height: 280px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #1e40af, #020617);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 0 40px rgba(56, 189, 248, 0.2);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
            cursor: pointer; position: relative; z-index: 10;
        }

        /* 3D Touch/Press Effect */
        .orb-3d:active {
            transform: scale(0.92) translateY(10px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.9), inset 0 0 60px rgba(56, 189, 248, 0.4);
        }

        /* Neural Glow */
        .listening-mode { box-shadow: 0 0 80px rgba(34, 197, 94, 0.4); }
        .is-speaking .bar { display: block; animation: speech-wave 0.5s infinite alternate; }
        
        .bar { width: 4px; height: 10px; background: #38bdf8; margin: 0 3px; border-radius: 2px; display: none; }
        @keyframes speech-wave { 0% { height: 10px; } 100% { height: 60px; } }
    </style>
</head>
<body>

    <div id="snow-field"></div>

    <div class="flex flex-col items-center">
        <div id="orb" class="orb-3d" onmousedown="triggerHaptic()" onmouseup="startJIVA()">
            <div id="visualizer" class="flex items-center">
                <div class="bar" style="animation-delay: 0.1s"></div>
                <div class="bar" style="animation-delay: 0.3s"></div>
                <div class="bar" style="animation-delay: 0.2s"></div>
                <div class="bar" style="animation-delay: 0.4s"></div>
            </div>
            <span id="label" class="text-blue-100 font-bold tracking-[0.4em] text-2xl uppercase">JIVA</span>
        </div>
        <p id="status" class="mt-12 text-blue-400/40 font-mono text-xs tracking-widest uppercase">3D_TOUCH_READY</p>
    </div>

    <script>
        // Snowflake generation
        for(let i=0; i<40; i++) {
            let flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.innerHTML = 'â†';
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = (Math.random() * 3 + 5) + 's';
            document.getElementById('snow-field').appendChild(flake);
        }

        let recognition;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.onresult = (e) => processVoice(e.results[e.results.length - 1][0].transcript);
        }

        // Beautiful Human Voice Engine
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            
            // PRIORITY: Siri -> Samantha -> Ava -> Victoria (Best Female Voices)
            const humanVoice = voices.find(v => v.name.includes('Siri') || v.name.includes('Samantha') || v.name.includes('Ava'));
            if (humanVoice) utterance.voice = humanVoice;

            utterance.pitch = 1.0; 
            utterance.rate = 0.95; // Slightly slower feels more 'thoughtful' and human
            utterance.volume = 1.0;

            utterance.onstart = () => {
                document.getElementById('orb').classList.add('is-speaking');
                document.getElementById('label').style.opacity = '0';
                if(recognition) recognition.stop();
            };
            utterance.onend = () => {
                document.getElementById('orb').classList.remove('is-speaking');
                document.getElementById('label').style.opacity = '1';
                if(recognition) recognition.start();
            };
            window.speechSynthesis.speak(utterance);
        }

        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(20); // Simulates 3D Touch haptic
        }

        async function startJIVA() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('orb').classList.add('listening-mode');
                document.getElementById('status').innerText = "Vocal Core Active";
                speak("I'm here. How can I help you today?");
            } catch(e) { document.getElementById('status').innerText = "Mic Error"; }
        }

        async function processVoice(text) {
            document.getElementById('status').innerText = "Processing Pulse...";
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: text })
            });
            const data = await res.json();
            speak(data.reply);
        }

        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    </script>
</body>
</html>